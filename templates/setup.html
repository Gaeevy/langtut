{% extends "base.html" %}

{% block title %}Setup Your Spreadsheet{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8 text-center">
            <h2 class="mb-4">üìä Set Up Your Learning Spreadsheet</h2>
            
            <div class="alert alert-success mb-4">
                <h5>‚úÖ You're logged in with Google!</h5>
                <p>Now let's link your vocabulary spreadsheet to start learning.</p>
            </div>
            
            <div class="mb-4">
                <a href="{{ url_for('settings') }}" class="btn btn-primary btn-lg">
                    üìä Link My Spreadsheet
                </a>
            </div>
            
            <!-- Instructions -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5>üìù Don't have a spreadsheet yet?</h5>
                </div>
                <div class="card-body text-start">
                    <p>Create a Google Sheets spreadsheet with this structure:</p>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Column A</th>
                                    <th>Column B</th>
                                    <th>Column C</th>
                                    <th>Column D</th>
                                    <th>Column E</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>id</strong></td>
                                    <td><strong>word</strong></td>
                                    <td><strong>translation</strong></td>
                                    <td>equivalent</td>
                                    <td>example</td>
                                </tr>
                                <tr class="text-muted">
                                    <td>1</td>
                                    <td>ol√°</td>
                                    <td>hello</td>
                                    <td>hi</td>
                                    <td>Ol√°, como est√°?</td>
                                </tr>
                                <tr class="text-muted">
                                    <td>2</td>
                                    <td>obrigado</td>
                                    <td>thank you</td>
                                    <td>thanks</td>
                                    <td>Obrigado pela ajuda!</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info">
                        <strong>Tip:</strong> Make sure your spreadsheet is shared with your Google account and has at least the required columns: <code>id</code>, <code>word</code>, and <code>translation</code>.
                    </div>
                    <a href="https://docs.google.com/spreadsheets/create" target="_blank" class="btn btn-outline-success">
                        ‚ûï Create New Google Sheet
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Check localStorage on page load for saved spreadsheet
window.addEventListener('load', function() {
    const savedSpreadsheet = localStorage.getItem('user_spreadsheet_id');
    if (savedSpreadsheet) {
        // User has a saved spreadsheet, try to load it
        loadSavedSpreadsheet(savedSpreadsheet);
    }
});

function loadSavedSpreadsheet(spreadsheetId) {
    // Show loading message
    const container = document.querySelector('.container');
    const originalContent = container.innerHTML;
    container.innerHTML = `
        <div class="text-center mt-5">
            <h3>üîÑ Loading your saved spreadsheet...</h3>
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Checking if your previous spreadsheet is still accessible...</p>
        </div>
    `;
    
    fetch('/load-saved-spreadsheet', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({spreadsheet_id: spreadsheetId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to main app
            window.location.href = '/';
        } else {
            // Saved spreadsheet is invalid, clear it and show setup
            console.log('Saved spreadsheet invalid:', data.error);
            localStorage.removeItem('user_spreadsheet_id');
            container.innerHTML = originalContent;
            
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-warning alert-dismissible fade show';
            alertDiv.innerHTML = `
                <strong>Previous spreadsheet no longer accessible:</strong> ${data.error}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.prepend(alertDiv);
        }
    })
    .catch(error => {
        console.error('Error loading saved spreadsheet:', error);
        localStorage.removeItem('user_spreadsheet_id');
        container.innerHTML = originalContent;
        
        // Show error message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
            <strong>Error loading saved spreadsheet.</strong> Please set up a new one.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        container.prepend(alertDiv);
    });
}
</script>
{% endblock %} 