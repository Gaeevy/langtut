{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1060">
    <div id="settings-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toast-title">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toast-body">
            Message content
        </div>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="settings-header">
                <h2>
                    <i class="bi bi-gear-fill"></i> Settings
                </h2>
                <p class="text-muted mb-0">Manage your language preferences and spreadsheet configuration</p>
            </div>

            <!-- Flash messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% if spreadsheets and spreadsheets|length > 0 %}
            <!-- Current Status -->
            <div class="card settings-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0 bi-file-spreadsheet">Switch Spreadsheet</h5>
                </div>
                <div class="card-body">
                    <!-- Spreadsheet selector dropdown -->
                    <div class="mt-0">
                        <div class="input-group">
                            <select class="form-select" id="spreadsheet-selector">
                                {% for spreadsheet in spreadsheets %}
                                <option value="{{ spreadsheet.spreadsheet_id }}"
                                        {% if spreadsheet.is_active %}selected{% endif %}>
                                    {{ spreadsheet.spreadsheet_name or spreadsheet.spreadsheet_id }}
                                    {% if spreadsheet.is_active %} (Active){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="btn-group">
                                <button class="btn btn-primary btn-sm" onclick="activateSpreadsheet()"
                                        id="activate-spreadsheet-btn">
                                    <i class="bi bi-check-circle"></i> Activate
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm"
                                        onclick="confirmRemoveSpreadsheet()"
                                        title="Remove selected spreadsheet">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                        <div class="settings-info mt-2">
                            <small>
                                <i class="bi bi-info-circle"></i>
                                Select a spreadsheet from your list and click "Activate" to make it active.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Language Settings -->
            <div class="card settings-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0 bi-globe">Language Settings</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="original-language" class="form-label">Learning From:</label>
                            <select class="form-select" id="original-language">
                                <option value="ru">Russian (Русский)</option>
                                <option value="en">English</option>
                                <option value="es">Spanish (Español)</option>
                                <option value="fr">French (Français)</option>
                                <option value="de">German (Deutsch)</option>
                                <option value="it">Italian (Italiano)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="target-language" class="form-label">Learning To:</label>
                            <select class="form-select" id="target-language">
                                <option value="pt">Portuguese (Português)</option>
                                <option value="en">English</option>
                                <option value="es">Spanish (Español)</option>
                                <option value="fr">French (Français)</option>
                                <option value="de">German (Deutsch)</option>
                                <option value="it">Italian (Italiano)</option>
                                <option value="ru">Russian (Русский)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="hint-language" class="form-label">Interface Language:</label>
                            <select class="form-select" id="hint-language">
                                <option value="en">English</option>
                                <option value="pt">Portuguese (Português)</option>
                                <option value="es">Spanish (Español)</option>
                                <option value="fr">French (Français)</option>
                                <option value="de">German (Deutsch)</option>
                                <option value="it">Italian (Italiano)</option>
                                <option value="ru">Russian (Русский)</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-btn-group mt-3">
                        <button class="btn btn-primary" onclick="saveLanguageSettings()" id="save-lang-btn">
                            <i class="bi bi-save"></i> Save Settings
                        </button>
                        <button class="btn btn-outline-secondary" onclick="loadLanguageSettings()" id="reset-lang-btn">
                            <i class="bi bi-arrow-counterclockwise"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Spreadsheet ID input form -->
            <div class="card settings-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-link-45deg"></i> Link New Spreadsheet
                    </h5>
                </div>
                <div class="card-body">
                    <div class="settings-form-group">
                        <label for="spreadsheet_id" class="form-label">Spreadsheet ID or URL</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="spreadsheet_id"
                                value="{{ current_spreadsheet_id or '' }}"
                                placeholder="Paste Google Sheets URL or ID here">
                            <button class="btn btn-outline-primary" type="button"
                                    onclick="validateSpreadsheet()"
                                    id="validate-btn">
                                <i class="bi bi-check-circle"></i> Validate
                            </button>
                        </div>
                        <div class="settings-info">
                            <small>
                                <i class="bi bi-info-circle"></i>
                                You can paste the full URL (e.g., https://docs.google.com/spreadsheets/d/...)
                                or just the spreadsheet ID.
                            </small>
                        </div>
                    </div>

                    <!-- Hidden form for setting spreadsheet -->
                    <form method="POST" action="{{ url_for('settings.set_spreadsheet') }}"
                        id="confirm-form" style="display: none;">
                        <input type="hidden" name="spreadsheet_id" id="confirm-spreadsheet-id">
                        <input type="hidden" name="confirm" value="true">
                    </form>
                </div>
            </div>

            <!-- Spreadsheet content preview -->
            <div id="content-preview" class="preview-section" style="display: none;">
                <div class="card settings-card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Spreadsheet Preview</h5>
                    </div>
                    <div class="card-body">
                        <div id="spreadsheet-info"></div>

                        <div class="settings-btn-group mt-3">
                            <button class="btn btn-success" onclick="confirmSpreadsheet()" id="confirm-btn">
                                <i class="bi bi-check-circle"></i> Use This Spreadsheet
                            </button>
                            <button class="btn btn-outline-secondary" onclick="hidePreview()" id="cancel-preview-btn">
                                <i class="bi bi-x-circle"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Back button -->
            <div class="mt-4">
                <a href="{{ url_for('index.home') }}" class="btn btn-outline-primary">
                    ← Back to Learning
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Show toast notification
function showToast(message, type = 'info') {
    const toastEl = document.getElementById('settings-toast');
    const toastBody = document.getElementById('toast-body');
    const toastTitle = document.getElementById('toast-title');
    const toast = new bootstrap.Toast(toastEl);

    // Set icon and title based on type
    const icons = {
        success: '✓',
        danger: '✗',
        warning: '⚠',
        info: 'ℹ'
    };

    const titles = {
        success: 'Success',
        danger: 'Error',
        warning: 'Warning',
        info: 'Info'
    };

    // Update toast appearance
    toastEl.className = `toast border-${type}`;
    toastTitle.innerHTML = `${icons[type]} ${titles[type]}`;
    toastBody.innerHTML = message;

    // Show toast
    toast.show();
}

// Language settings functionality
function loadLanguageSettings() {
    fetch('/api/language-settings')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.language_settings;
                document.getElementById('original-language').value = settings.original;
                document.getElementById('target-language').value = settings.target;
                document.getElementById('hint-language').value = settings.hint;

                // Show metadata information if available
                let message = 'Language settings loaded successfully.';
                if (data.metadata && data.metadata.model_version === 'enhanced') {
                    message += ` (Using enhanced model validation)`;
                    if (!data.metadata.is_valid_configuration) {
                        message += ` Warning: Configuration has duplicate languages.`;
                    }
                }

                showLanguageResult(message, 'success');
            } else {
                showLanguageResult('Failed to load language settings: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showLanguageResult('Error loading language settings: ' + error.message, 'danger');
        });
}

function saveLanguageSettings() {
    const originalLang = document.getElementById('original-language').value;
    const targetLang = document.getElementById('target-language').value;
    const hintLang = document.getElementById('hint-language').value;

    const languageSettings = {
        original: originalLang,
        target: targetLang,
        hint: hintLang
    };

    // First validate the settings before saving
    validateLanguageSettings(languageSettings)
        .then(validationResult => {
            if (!validationResult.valid) {
                // Show validation errors
                let errorMessage = 'Validation failed:<br>';
                validationResult.validation_errors.forEach(error => {
                    errorMessage += `• ${error.field}: ${error.message}<br>`;
                });
                showLanguageResult(errorMessage, 'danger');
                return;
            }

            // Show warnings if any
            if (validationResult.warnings && validationResult.warnings.length > 0) {
                let warningMessage = 'Warning:<br>';
                validationResult.warnings.forEach(warning => {
                    warningMessage += `• ${warning}<br>`;
                });
                showLanguageResult(warningMessage, 'warning');
            }

            // Proceed with saving
            fetch('/api/language-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    language_settings: languageSettings
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = 'Language settings saved successfully!';
                    if (data.metadata && data.metadata.previous_settings) {
                        const prev = data.metadata.previous_settings;
                        message += `<br><small>Previous: ${prev.original} → ${prev.target} (${prev.hint})</small>`;
                    }
                    showLanguageResult(message, 'success');
                } else {
                    // Handle enhanced error responses
                    let errorMessage = 'Failed to save language settings: ' + data.error;

                    if (data.validation_errors && data.validation_errors.length > 0) {
                        errorMessage += '<br>Validation errors:<br>';
                        data.validation_errors.forEach(error => {
                            errorMessage += `• ${error.field}: ${error.message}<br>`;
                        });
                    }

                    if (data.suggestion) {
                        errorMessage += '<br>Suggestion: ' + data.suggestion;
                    }

                    showLanguageResult(errorMessage, 'danger');
                }
            })
            .catch(error => {
                showLanguageResult('Error saving language settings: ' + error.message, 'danger');
            });
        })
        .catch(error => {
            showLanguageResult('Error validating language settings: ' + error.message, 'danger');
        });
}

function validateLanguageSettings(languageSettings) {
    return fetch('/api/language-settings/validate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            language_settings: languageSettings
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            return {
                valid: data.valid,
                validation_errors: data.validation_errors || [],
                warnings: data.warnings || []
            };
        } else {
            throw new Error(data.error || 'Validation failed');
        }
    });
}

function showLanguageResult(message, type) {
    showToast(message, type);
}

// Helper function to set button loading state
function setButtonLoading(buttonId, isLoading, originalText = null) {
    const button = document.getElementById(buttonId);
    if (!button) return;

    if (isLoading) {
        button.dataset.originalText = button.innerHTML;
        button.classList.add('btn-loading');
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Loading...';
    } else {
        button.classList.remove('btn-loading');
        button.disabled = false;
        button.innerHTML = originalText || button.dataset.originalText;
    }
}

// Spreadsheet activation functionality
function activateSpreadsheet() {
    const selector = document.getElementById('spreadsheet-selector');
    const selectedSpreadsheetId = selector.value;
    const button = document.getElementById('activate-spreadsheet-btn');

    if (!selectedSpreadsheetId) {
        showToast('Please select a spreadsheet', 'warning');
        return;
    }

    // Show loading state
    setButtonLoading('activate-spreadsheet-btn', true);

    fetch('/settings/activate-spreadsheet', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            spreadsheet_id: selectedSpreadsheetId
        })
    })
    .then(response => response.json())
    .then(data => {
        setButtonLoading('activate-spreadsheet-btn', false, '<i class="bi bi-check-circle"></i> Activate');

        if (data.success) {
            showToast('Spreadsheet activated successfully', 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showToast('Failed to activate spreadsheet: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        setButtonLoading('activate-spreadsheet-btn', false, '<i class="bi bi-check-circle"></i> Activate');
        showToast('Error: ' + error.message, 'danger');
    });
}

function confirmRemoveSpreadsheet() {
    const selector = document.getElementById('spreadsheet-selector');
    const selectedOption = selector.options[selector.selectedIndex];
    const selectedSpreadsheetId = selector.value;
    const selectedSpreadsheetName = selectedOption.text;

    if (!selectedSpreadsheetId) {
        showToast('Please select a spreadsheet to remove', 'warning');
        return;
    }

    if (confirm(`Are you sure you want to remove "${selectedSpreadsheetName}" from your list? This will not delete the actual Google Sheet.`)) {
        fetch('/settings/remove-spreadsheet', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                spreadsheet_id: selectedSpreadsheetId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Spreadsheet removed successfully', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showToast('Failed to remove spreadsheet: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showToast('Error: ' + error.message, 'danger');
        });
    }
}

function validateSpreadsheet() {
    const spreadsheetId = document.getElementById('spreadsheet_id').value.trim();
    const previewDiv = document.getElementById('content-preview');
    const validateBtn = document.getElementById('validate-btn');

    if (!spreadsheetId) {
        showToast('Please enter a spreadsheet ID or URL', 'danger');
        return;
    }

    // Show loading state
    setButtonLoading('validate-btn', true);
    previewDiv.style.display = 'none';

    fetch('/validate-spreadsheet', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            spreadsheet_url: spreadsheetId
        })
    })
    .then(response => response.json())
    .then(data => {
        setButtonLoading('validate-btn', false, '<i class="bi bi-check-circle"></i> Validate');

        if (data.success) {
            // Show preview...
            showPreview(data);
        } else {
            showToast('Validation failed: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        setButtonLoading('validate-btn', false, '<i class="bi bi-check-circle"></i> Validate');
        showToast('Error: ' + error.message, 'danger');
    });
}

function confirmSpreadsheet() {
    const spreadsheetId = document.getElementById('confirm-spreadsheet-id').value;
    const button = document.querySelector('#content-preview .btn-success');
    const cancelButton = document.querySelector('#content-preview .btn-outline-secondary');

    // Show loading state
    button.disabled = true;
    cancelButton.disabled = true;
    button.innerHTML = '⏳ Setting up...';

    fetch('/set-spreadsheet', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            spreadsheet_id: spreadsheetId,
            confirm: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            button.innerHTML = '✅ Success!';
            button.className = 'btn btn-success';

            // Reload page after short delay
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            // Show error
            button.innerHTML = '❌ Error';
            button.className = 'btn btn-danger';

            // Show error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger mt-2';
            errorDiv.innerHTML = `<strong>Error:</strong> ${data.error}`;
            document.querySelector('#content-preview .card-body').appendChild(errorDiv);

            // Reset buttons after delay
            setTimeout(() => {
                button.disabled = false;
                cancelButton.disabled = false;
                button.innerHTML = '✓ Use This Spreadsheet';
                button.className = 'btn btn-success';
            }, 3000);
        }
    })
    .catch(error => {
        // Show error
        button.innerHTML = '❌ Error';
        button.className = 'btn btn-danger';

        // Show error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger mt-2';
        errorDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
        document.querySelector('#content-preview .card-body').appendChild(errorDiv);

        // Reset buttons after delay
        setTimeout(() => {
            button.disabled = false;
            cancelButton.disabled = false;
            button.innerHTML = '✓ Use This Spreadsheet';
            button.className = 'btn btn-success';
        }, 3000);
    });
}

function showPreview(data) {
    const previewDiv = document.getElementById('content-preview');

    // Build preview content
    let cardSetsInfo = '';
    if (data.card_sets && data.card_sets.length > 0) {
        cardSetsInfo = '<h6 class="mb-3">Card Sets Found:</h6><ul class="list-unstyled">';
        data.card_sets.forEach(cs => {
            cardSetsInfo += `
                <li class="mb-2">
                    <i class="bi bi-folder-fill text-primary"></i>
                    <strong>${cs.name}</strong>
                    <span class="badge bg-secondary">${cs.card_count} cards</span>
                </li>`;
        });
        cardSetsInfo += '</ul>';
    }

    document.getElementById('spreadsheet-info').innerHTML = `
        <div class="status-badge status-badge-success mb-3">
            <i class="bi bi-check-circle-fill"></i> Spreadsheet Validated Successfully
        </div>
        <div class="mb-3">
            <small class="text-muted d-block mb-1">Spreadsheet Name:</small>
            <div class="spreadsheet-id-display">
                ${data.spreadsheet_name}
            </div>
        </div>
        ${cardSetsInfo}
    `;

    document.getElementById('confirm-spreadsheet-id').value = data.spreadsheet_id;

    // Update the name of the current table in the block Current Status
    const spreadsheetNameElement = document.querySelector('.spreadsheet-id-display');
    if (spreadsheetNameElement) {
        spreadsheetNameElement.textContent = data.spreadsheet_name;
    }

    // Show with animation
    previewDiv.style.display = 'block';
    setTimeout(() => {
        previewDiv.classList.add('show');
    }, 10);
}

function hidePreview() {
    const previewDiv = document.getElementById('content-preview');
    previewDiv.classList.remove('show');
    setTimeout(() => {
        previewDiv.style.display = 'none';
    }, 300);
}

function resetSpreadsheet() {
    return true;
}

function updateActivateButtonState() {
    const selector = document.getElementById('spreadsheet-selector');
    const activateBtn = document.getElementById('activate-spreadsheet-btn');
    const selectedOption = selector.options[selector.selectedIndex];

    if (selectedOption.text.includes('(Active)')) {
        activateBtn.disabled = true;
        activateBtn.classList.add('disabled');
        activateBtn.title = 'This spreadsheet is already active';
    } else {
        activateBtn.disabled = false;
        activateBtn.classList.remove('disabled');
        activateBtn.title = 'Activate selected spreadsheet';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const selector = document.getElementById('spreadsheet-selector');
    if (selector) {
        selector.addEventListener('change', updateActivateButtonState);
        updateActivateButtonState();
    }

    loadLanguageSettings();
});
</script>
{% endblock %}
