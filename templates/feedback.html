{% extends "base.html" %}

{% block title %}{% if mode == 'review' %}Review - Flip Side{% else %}Feedback{% endif %}{% endblock %}

{% block content %}
<div class="text-center">
    <!-- Progress bar - shown for both study and review modes -->
    {% if mode == 'review' %}
    <div class="text-center mb-4">
        <div class="progress-container">
            <div class="progress" style="height: 10px;">
                <div class="progress-bar pastel-progress-review" role="progressbar"
                     style="width: {{ (index / total * 100)|round }}%;"
                     aria-valuenow="{{ index }}" aria-valuemin="0" aria-valuemax="{{ total }}"></div>
            </div>
            <div class="d-flex justify-content-between mt-1">
                <small>Card {{ index + 1 }} of {{ total }} (Browse)</small>
                <small>{{ (index / total * 100)|round }}% complete</small>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Visual feedback indicator - only for study mode -->
    {% if mode != 'review' %}
    <div class="feedback-indicator mb-4">
        {% if correct %}
        <div class="success-indicator">
            <i class="bi bi-check-circle-fill"></i>
        </div>
        {% else %}
        <div class="error-indicator">
            <i class="bi bi-x-circle-fill"></i>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Navigation arrows for review mode -->
    {% if mode == 'review' %}
    <div class="review-navigation mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <a href="{{ url_for('review.navigate', direction='prev') }}" class="btn btn-secondary btn-sm nav-arrow-btn" id="nav-prev">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div class="text-center">
                <small class="text-muted">Click card to flip back</small>
            </div>
            <a href="{{ url_for('review.navigate', direction='next') }}" class="btn btn-secondary btn-sm nav-arrow-btn" id="nav-next">
                <i class="bi bi-arrow-right"></i>
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Card with visual border feedback -->
    <div class="language-card feedback-card {% if correct %}correct-card{% else %}incorrect-card{% endif %} mb-4" {% if mode == 'review' %}onclick="flipCard()" style="cursor: pointer;"{% endif %}>
        <div class="row">
            <div class="col-md-12 text-center">
                <!-- 1. Portuguese word (main focus) with TTS button -->
                <div class="word-with-audio mb-3">
                    <h2 class="card-word-main text-dark fw-bold mb-2" data-tts="{{ card.word }}">{{ card.word }}</h2>
                    <button type="button" class="btn btn-primary btn-sm" id="speak-card-btn" title="Listen to pronunciation">
                        <i class="bi bi-volume-up"></i>
                    </button>
                </div>

                <!-- 2. English translation -->
                <p class="card-translation h5 text-secondary mb-3">{{ card.translation }}</p>

                <!-- 3. Portuguese example sentence -->
                {% if card.example %}
                <p class="card-example text-muted fst-italic mb-3" style="font-size: 1.1rem; line-height: 1.4;" data-tts="{{ card.example }}">{{ card.example }}</p>
                {% endif %}

                <!-- 4. Example translation -->
                {% if card.example_translation %}
                <p class="card-example-translation small text-muted fst-italic mb-3" style="opacity: 0.8;">
                    <em>{{ card.example_translation }}</em>
                </p>
                {% endif %}

                <!-- Animated Level Progress Dots -->
                <div class="level-progress-container">
                    <div class="level-tooltip">Level {{ card.level.value if card.level.value is defined else card.level }}</div>
                    <div class="level-progress">
                        {% set level_value = card.level.value if card.level.value is defined else card.level %}
                        {% for i in range(8) %}
                        <div class="level-dot {% if i < level_value %}completed{% elif i == level_value %}current{% endif %}"
                             data-level="{{ i }}"></div>
                        {% endfor %}
                    </div>
                    {% if reviewing %}
                    <small class="text-warning"><i class="bi bi-arrow-repeat"></i> Review</small>
                    {% endif %}
                </div>

                <!-- Difficulty rating for correct answers - only for learn mode -->
                {% if correct and not reviewing and mode != 'review' %}
                <div class="difficulty-rating mt-4">
                    <p class="small text-muted mb-2">How was this card?</p>
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('learn.rate_difficulty', card_index=card_index, difficulty='easy') }}"
                           class="btn btn-success btn-sm">
                            ðŸ˜Š Easy
                        </a>
                        <a href="{{ url_for('learn.rate_difficulty', card_index=card_index, difficulty='difficult') }}"
                           class="btn btn-warning btn-sm">
                            ðŸ˜° Difficult
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Next card button - only for learn mode -->
    {% if mode != 'review' %}
    <div class="d-grid gap-2 mt-3">
        <a href="{{ url_for('learn.next_card') }}" class="btn btn-primary">Next Card</a>
    </div>
    {% else %}
    <!-- Review mode - back to home -->
    <div class="text-center mt-3">
        <a href="{{ url_for('index.home') }}" class="btn btn-secondary btn-sm">
            <i class="bi bi-house"></i> Back to Home
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<!-- Card data for JavaScript -->
<script type="application/json" id="card-data">
{
    "word": {{ card.word|tojson }},
    "example": {{ card.example|tojson if card.example else 'null' }},
    "correct": {{ 'true' if correct else 'false' }},
    "level": {{ card.level.value if card.level.value is defined else card.level }},
    "levelChange": {{ level_change|tojson if level_change else 'null' }},
    "spreadsheetId": {{ user_spreadsheet_id|tojson if user_spreadsheet_id else 'null' }},
    "sheetGid": {{ sheet_gid|tojson if sheet_gid else 'null' }},
    "mode": {{ mode|tojson if mode else '"learn"' }}
}
</script>

<script>
    window.cardMode = {{ mode|tojson if mode else '"learn"' }};
    window.reviewCardUrl = '{{ url_for("review.card") }}';
</script>

<!-- External scripts -->
<script src="{{ url_for('static', filename='js/tts.js') }}"></script>
<script src="{{ url_for('static', filename='js/feedback.js') }}"></script>
{% endblock %}
