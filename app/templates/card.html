{% extends "base.html" %}

{% block title %}{% if mode == 'review' %}Review{% else %}Flashcard{% endif %}{% endblock %}

{% block content %}
<div class="text-center mb-4">
    {% if reviewing %}
    <div class="alert alert-warning mb-3">
        <strong>Review Mode:</strong> Let's practice the cards you missed earlier.
    </div>
    {% endif %}

    <!-- Progress bar - shown for both study and review modes -->
    <div class="progress-container">
        <div class="progress" style="height: 10px;">
            <div class="progress-bar {% if reviewing %}pastel-progress-warning{% elif mode == 'review' %}pastel-progress-review{% else %}pastel-progress-study{% endif %}" role="progressbar"
                 style="width: {{ (index / total * 100)|round }}%;"
                 aria-valuenow="{{ index }}" aria-valuemin="0" aria-valuemax="{{ total }}"></div>
        </div>
        <div class="d-flex justify-content-between mt-1">
            <small>Card {{ index + 1 }} of {{ total }}{% if reviewing %} (Review){% elif mode == 'review' %} (Browse){% endif %}</small>
            <small>{{ (index / total * 100)|round }}% complete</small>
        </div>
    </div>
</div>

<!-- Navigation arrows for review mode -->
{% if mode == 'review' %}
<div class="review-navigation mb-3">
    <div class="d-flex justify-content-between align-items-center">
        <a href="{{ url_for('review.navigate', direction='prev') }}" class="btn btn-secondary btn-sm nav-arrow-btn" id="nav-prev">
            <i class="bi bi-arrow-left"></i>
        </a>
        <div class="text-center">
            <small class="text-muted">Click card to flip</small>
        </div>
        <a href="{{ url_for('review.navigate', direction='next') }}" class="btn btn-secondary btn-sm nav-arrow-btn" id="nav-next">
            <i class="bi bi-arrow-right"></i>
        </a>
    </div>
</div>
{% endif %}

<div class="language-card mb-4" {% if mode == 'review' %}onclick="flipCard()" style="cursor: pointer;"{% endif %}>
    <div class="row">
        <div class="col-md-12 text-center">
            <!-- Main translation (English) - larger and more prominent -->
            <h3 class="card-translation-main text-dark fw-semibold mb-3">{{ card.translation }}</h3>

            <!-- Example translation - medium size, italicized -->
            {% if card.example_translation %}
            <p class="card-example-translation text-secondary fst-italic mb-3" style="font-size: 1.2rem; line-height: 1.3;">{{ card.example_translation }}</p>
            {% endif %}

            <!-- Toggle for English equivalent only -->
            {% if card.equivalent %}
            <div class="equivalent-toggle mb-3">
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEquivalent()">
                    <i class="bi bi-eye" id="toggle-icon"></i> Show hint
                </button>
                <div id="equivalent-content" style="display: none;" class="mt-2">
                    <p class="text-muted"><strong>Equivalent:</strong> {{ card.equivalent }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Level Progress Dots -->
            <div class="level-progress-container">
                <div class="level-tooltip">Level {{ card.level.value if card.level.value is defined else card.level }}</div>
                <div class="level-progress">
                    {% set level_value = card.level.value if card.level.value is defined else card.level %}
                    {% for i in range(8) %}
                    <div class="level-dot {% if i < level_value %}completed{% elif i == level_value %}current{% endif %}"></div>
                    {% endfor %}
                </div>
                {% if card.is_review %}
                <small class="text-warning"><i class="bi bi-arrow-repeat"></i> Review</small>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Answer form - only for learn mode -->
{% if mode != 'review' %}
<form action="{{ url_for('learn.answer') }}" method="post">
    <div class="mb-3">
        <input type="text" name="user_answer" class="form-control form-control-lg"
               placeholder="Type your answer..." autocomplete="off" required>
    </div>
    <div class="d-grid">
        <button type="submit" class="btn btn-primary btn-lg">Submit</button>
    </div>
</form>

<div class="text-center mt-3">
    <a href="{{ url_for('learn.end_early') }}" class="btn btn-outline-secondary btn-sm"
       onclick="return confirm('Are you sure you want to end the session? Your progress so far will be saved.');">
        End Session Early
    </a>
</div>
{% else %}
<!-- Review mode - back to index -->
<div class="text-center mt-3">
    <a href="{{ url_for('index.home') }}" class="btn btn-secondary btn-sm">
        <i class="bi bi-house"></i> Back to Home
    </a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Page data for JavaScript -->
<script>
    window.cardContext = {
        spreadsheetId: {{ user_spreadsheet_id|tojson if user_spreadsheet_id else 'null' }},
        sheetGid: {{ sheet_gid|tojson if sheet_gid else 'null' }}
    };
    window.cardData = {
        word: {{ card.word|tojson if card.word else 'null' }},
        example: {{ card.example|tojson if card.example else 'null' }}
    };
    window.cardMode = {{ mode|tojson if mode else '"learn"' }};
    window.reviewFlipUrl = '{{ url_for("review.flip") }}';
</script>

<!-- External scripts -->
<script src="{{ url_for('static', filename='js/tts.js') }}"></script>
<script src="{{ url_for('static', filename='js/card.js') }}"></script>
{% endblock %}
